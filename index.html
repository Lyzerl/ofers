<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת הצעות מחיר</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; }
        .column { flex: 1; padding: 10px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; }
        input, select { width: 100%; }
        .menu-category { margin-left: 20px; }
        .add-item { cursor: pointer; color: blue; }
        #error-message { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="column">
            <h2>מערכת הצעות מחיר</h2>
            <div class="form-group">
                <label for="customerName">שם לקוח:</label>
                <input type="text" id="customerName">
            </div>
            <div class="form-group">
                <label for="phone">טלפון:</label>
                <input type="tel" id="phone">
            </div>
            <div class="form-group">
                <label for="email">דוא"ל:</label>
                <input type="email" id="email">
            </div>
            <div class="form-group">
                <label for="eventLocation">מיקום האירוע:</label>
                <input type="text" id="eventLocation">
            </div>
            <div class="form-group">
                <label for="address">כתובת:</label>
                <input type="text" id="address">
            </div>
            <div class="form-group">
                <label for="date">תאריך:</label>
                <input type="date" id="date">
            </div>
            <div class="form-group">
                <label for="contactPerson">איש קשר:</label>
                <input type="text" id="contactPerson">
            </div>
            <div class="form-group">
                <label for="contactPhone">טלפון איש קשר:</label>
                <input type="tel" id="contactPhone">
            </div>
            <div class="form-group">
                <label for="menuType">סוג תפריט:</label>
                <select id="menuType"></select>
            </div>
            <div id="menuPrice"></div>
        </div>
        <div class="column">
            <div id="menuItems"></div>
            <div class="form-group">
                <label for="delivery">הובלה:</label>
                <input type="number" id="delivery">
            </div>
            <div id="summary"></div>
            <button onclick="generatePDF()">ייצוא ל-PDF</button>
            <button onclick="generateExcel()">ייצוא ל-Excel</button>
        </div>
    </div>
    <div id="error-message"></div>

    <script>
        const errorMessageElement = document.getElementById('error-message');
        const baseUrl = 'https://raw.githubusercontent.com/lyzerl/ofers/main/';
        const files = {
            menus: 'MENUS.csv',
            priceList: 'PRICE_LIST.csv'
        };

        let menus, priceList;

        Promise.all([
            loadCSV(baseUrl + files.menus),
            loadCSV(baseUrl + files.priceList)
        ]).then(([menusData, priceListData]) => {
            menus = menusData;
            priceList = priceListData;
            populateMenuTypes();
            errorMessageElement.textContent = 'הקבצים נטענו בהצלחה!';
        }).catch(error => {
            console.error('Error loading CSV files:', error);
            errorMessageElement.textContent = 'שגיאה בטעינת הקבצים: ' + error.message;
        });

        function loadCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            reject(new Error(`שגיאה בקובץ ${url}: ${results.errors[0].message}`));
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: function(error) {
                        reject(new Error(`שגיאה בטעינת הקובץ ${url}: ${error}`));
                    }
                });
            });
        }

        function populateMenuTypes() {
            const menuTypeSelect = document.getElementById('menuType');
            menus.forEach(menu => {
                const option = document.createElement('option');
                option.value = menu['סוג תפריט'];
                option.textContent = menu['סוג תפריט'];
                menuTypeSelect.appendChild(option);
            });
            menuTypeSelect.addEventListener('change', updateMenuItems);
            updateMenuItems();
        }

        function updateMenuItems() {
            const selectedMenuType = document.getElementById('menuType').value;
            const menuItems = document.getElementById('menuItems');
            const menuPrice = document.getElementById('menuPrice');
            menuItems.innerHTML = '';

            const selectedMenu = menus.find(menu => menu['סוג תפריט'] === selectedMenuType);
            if (!selectedMenu) return;

            menuPrice.textContent = `מחיר מנה: ₪${selectedMenu['מחיר למנה']}`;

            const categories = [
                { name: 'סלטים', quantity: selectedMenu['כמות סלטים'], maxPrice: Infinity },
                { name: 'מנות ראשונות', quantity: selectedMenu['כמות מנות ראשונות'], maxPrice: selectedMenu['מקסימום מחיר מנה ראשונה'] },
                { name: 'מנות עיקריות', quantity: selectedMenu['כמות מנות עיקריות'], maxPrice: selectedMenu['מקסימום מחיר מנה עיקרית'] },
                { name: 'תוספות', quantity: selectedMenu['כמות תוספות'], maxPrice: selectedMenu['מקסימום מחיר לתוספות'] },
                { name: 'קינוחים', quantity: 1, maxPrice: selectedMenu['מחיר מקסימום לקינוח'] },
                { name: 'לחמניות', quantity: selectedMenu['כמות לחמניה'], maxPrice: Infinity }
            ];

            categories.forEach(category => {
                const categoryItems = priceList.filter(item => 
                    item['קטגוריה'] === category.name && parseFloat(item['מחיר']) <= category.maxPrice
                );

                if (categoryItems.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h3>${category.name}</h3>`;
                    menuItems.appendChild(categoryDiv);

                    for (let i = 0; i < category.quantity; i++) {
                        const select = document.createElement('select');
                        select.innerHTML = '<option value="">בחר פריט</option>';
                        categoryItems.forEach(item => {
                            select.innerHTML += `<option value="${item['מחיר']}">${item['פריט']} - ₪${item['מחיר']}</option>`;
                        });
                        select.addEventListener('change', updateSummary);
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'menu-category';
                        itemDiv.appendChild(select);
                        menuItems.appendChild(itemDiv);
                    }

                    const addItemSpan = document.createElement('span');
                    addItemSpan.textContent = '+ הוסף פריט';
                    addItemSpan.className = 'add-item';
                    addItemSpan.onclick = () => addExtraItem(category.name, categoryItems);
                    menuItems.appendChild(addItemSpan);
                }
            });

            updateSummary();
        }

        function addExtraItem(category, items) {
            const select = document.createElement('select');
            select.innerHTML = '<option value="">בחר פריט נוסף</option>';
            items.forEach(item => {
                select.innerHTML += `<option value="${item['מחיר']}">${item['פריט']} - ₪${item['מחיר']}</option>`;
            });
            select.addEventListener('change', updateSummary);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-category';
            itemDiv.appendChild(select);
            document.getElementById('menuItems').appendChild(itemDiv);
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const selectedItems = document.querySelectorAll('#menuItems select');
            const delivery = parseFloat(document.getElementById('delivery').value) || 0;
            const menuType = document.getElementById('menuType').value;
            const selectedMenu = menus.find(menu => menu['סוג תפריט'] === menuType);
            
            let total = parseFloat(selectedMenu['מחיר למנה']) + delivery;
            let summaryHTML = '<h3>סיכום הזמנה</h3><ul>';
            summaryHTML += `<li>מחיר בסיס למנה: ₪${selectedMenu['מחיר למנה']}</li>`;
            
            selectedItems.forEach(item => {
                if (item.value) {
                    const price = parseFloat(item.value);
                    total += price;
                    summaryHTML += `<li>${item.options[item.selectedIndex].text}</li>`;
                }
            });
            
            summaryHTML += `<li>הובלה: ₪${delivery}</li>`;
            summaryHTML += `</ul><p>סה"כ: ₪${total}</p>`;
            
            summary.innerHTML = summaryHTML;
        }

        document.getElementById('delivery').addEventListener('input', updateSummary);

        function generatePDF() {
            alert('פונקציונליות ייצוא ל-PDF תתווסף בהמשך');
        }

        function generateExcel() {
            alert('פונקציונליות ייצוא ל-Excel תתווסף בהמשך');
        }
    </script>
</body>
</html>
