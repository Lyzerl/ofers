<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת הצעות מחיר לקייטרינג</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* סגנונות CSS נשארים ללא שינוי */
    </style>
</head>
<body>
    <div class="container">
        <h1>מערכת הצעות מחיר לקייטרינג</h1>
        <form id="quoteForm">
            <!-- שדות הטופס נשארים ללא שינוי -->
        </form>
    </div>

    <script>
        let menuTypes = {};
        let priceList = {};

        // פונקציה לטעינת קובץ CSV
        function loadCSV(file, callback) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: callback
            });
        }

        // טעינת קובץ התפריטים
        loadCSV('menu.csv', function(results) {
            results.data.forEach(row => {
                if (row['סוג תפריט']) {
                    menuTypes[row['סוג תפריט']] = {
                        salads: row['כמות סלטים'],
                        starters: row['כמות מנות ראשונות'],
                        mainDishes: row['כמות מנות עיקריות'],
                        sideDishes: row['כמות תוספות'],
                        maxStarterPrice: row['מקסימום מחיר מנה ראשונה'],
                        maxMainPrice: row['מקסימום מחיר מנה עיקרית'],
                        maxSidePrice: row['מקסימום מחיר לתוספות'],
                        maxDessertPrice: row['מחיר מקסימום לקינוח'],
                        breadRolls: row['כמות לחמניה'],
                        pricePerPerson: row['מחיר למנה']
                    };
                }
            });
            loadMenuTypeOptions();
        });

        // טעינת קובץ המחירון
        loadCSV('pricelist.csv', function(results) {
            results.data.forEach(row => {
                if (row['קטגוריה'] && row['שם מנה']) {
                    if (!priceList[row['קטגוריה']]) {
                        priceList[row['קטגוריה']] = {};
                    }
                    priceList[row['קטגוריה']][row['שם מנה']] = row['מחיר'];
                }
            });
        });

        // פונקציה לטעינת אפשרויות התפריט
        function loadMenuTypeOptions() {
            const menuTypeSelect = document.getElementById('menuType');
            menuTypeSelect.innerHTML = '<option value="">בחר תפריט</option>';
            for (const type in menuTypes) {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                menuTypeSelect.appendChild(option);
            }
        }

        // פונקציה לטעינת פריטי התפריט
        function loadMenuItems() {
            const menuType = document.getElementById('menuType').value;
            const menuItemsContainer = document.getElementById('menuItems');
            menuItemsContainer.innerHTML = '';

            if (menuType) {
                for (const category in priceList) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'menu-category';
                    categoryDiv.innerHTML = `<h3>${category}</h3>`;

                    for (const item in priceList[category]) {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'menu-item';
                        itemDiv.innerHTML = `
                            <input type="checkbox" id="${item}" name="${category}" value="${item}">
                            <label for="${item}">${item} (₪${priceList[category][item]})</label>
                            <input type="number" id="${item}_quantity" min="0" value="0" style="width: 50px;">
                        `;
                        categoryDiv.appendChild(itemDiv);
                    }

                    menuItemsContainer.appendChild(categoryDiv);
                }
            }
        }

        // הוספת מאזין אירועים לשינוי בסוג התפריט
        document.getElementById('menuType').addEventListener('change', loadMenuItems);

        // פונקציה לחישוב סיכום ההזמנה
        function calculateSummary() {
            const menuType = document.getElementById('menuType').value;
            const guestCount = parseInt(document.getElementById('guestCount').value) || 0;
            const deliveryCost = parseFloat(document.getElementById('delivery').value) || 0;

            if (!menuType || guestCount === 0) {
                document.getElementById('summary').innerHTML = '<p>נא למלא את כל השדות הנדרשים.</p>';
                return;
            }

            let totalCost = menuTypes[menuType].pricePerPerson * guestCount;
            let additionalItems = [];

            document.querySelectorAll('#menuItems input[type="checkbox"]:checked').forEach(item => {
                const category = item.name;
                const itemName = item.value;
                const quantity = parseInt(document.getElementById(`${itemName}_quantity`).value) || 0;
                const price = priceList[category][itemName];
                const itemTotal = price * quantity;
                totalCost += itemTotal;
                if (quantity > 0) {
                    additionalItems.push(`${itemName} (${quantity}x): ₪${itemTotal.toFixed(2)}`);
                }
            });

            totalCost += deliveryCost;

            let summaryHTML = `
                <h2>סיכום הזמנה</h2>
                <p>סוג תפריט: ${menuType}</p>
                <p>מספר אורחים: ${guestCount}</p>
                <p>מחיר בסיס למנה: ₪${menuTypes[menuType].pricePerPerson}</p>
                <p>סה"כ מחיר בסיס: ₪${(menuTypes[menuType].pricePerPerson * guestCount).toFixed(2)}</p>
            `;

            if (additionalItems.length > 0) {
                summaryHTML += '<h3>פריטים נוספים:</h3><ul>';
                additionalItems.forEach(item => {
                    summaryHTML += `<li>${item}</li>`;
                });
                summaryHTML += '</ul>';
            }

            summaryHTML += `
                <p>עלות הובלה: ₪${deliveryCost.toFixed(2)}</p>
                <h3>סה"כ לתשלום: ₪${totalCost.toFixed(2)}</h3>
            `;

            document.getElementById('summary').innerHTML = summaryHTML;
        }

        // הוספת מאזיני אירועים לשינויים בטופס
        document.getElementById('quoteForm').addEventListener('change', calculateSummary);

        // פונקציות הייצוא נשארות ללא שינוי
        function exportToPDF() {
            // קוד ייצוא ל-PDF
        }

        function exportToExcel() {
            // קוד ייצוא ל-Excel
        }
    </script>
</body>
</html>
